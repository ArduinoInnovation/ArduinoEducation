# 小车码字规范

---

## 版本与修改记录
|版本号|修改日期|修改人|修改摘要
|---|---|---|---|
0.1|2018.03.24|冯诗伟、马白家欣|创建文件
0.2|2018.03.25|冯诗伟|h1-3.0中允许范围改为0～255
||||h2-1.0.2中的发送时间改为8个档位
||||添加h2、c2、c3控制字
||||添加c5控制字中关于避障半径的说明
0.3|2018.04.10|冯诗伟|增加判断是否启用马达的位
||||增加超声波持续时间
---
## 总体概述
- 用户编写图形化程序控制小车。小车分为主机和从机，用户编写图像化程序时有两种模式。
  - 一种是只给主机编写行为，只控制一辆小车，通过串口烧录到开发板上；
  - 另一种是即给主机编写行为，也给从机编写行为，这样就需要两个编写程序的窗口。
  用户把所有的信息都通过串口传给主机，主机通过红外控制从机行为，从而达到多机器人的集体行为。
- 本规范受ELF头文件格式的启发，分为头位串和控制字串两部分。
  - 头位串共计32bit。头位串包括用例列表中h1-h3三项，描述主机将有多少种状态、主机将循环发送多少种状态给从机，以及为凑够32bit／同时方便扩展而存在的保留位。
  - 控制串共计32bit。目前包括用例列表中c1-c9这几项功能。
  - 头位串之后紧跟着h1个描述主机状态的控制串；再之后紧跟着h2个描述从机状态的控制串。

## 用例列表
|码字编号|功能|所占比特数|
|:---:|---|:---:|
|h1| 主机的全部状态数|8
|h2| 主机将循环发送给从机的控制字串的数目|16
|h3| 保留|8
|c1| A是否接受红外|1
|c2| B是否转发控制字|1
|c3| C驱动马达|6
|c4| x驱动LED|4
|c5| D超声波智能避障|5
|c6| E语音识别模块|1
|c7| x红外线人体感应|1
|c8| x保留|12
|c9| x奇偶校验|1

## 码字内容

### 主机头位串1: 主机的全部状态数
- **ID**
    - h1
- **名称**
    - 主机的全部状态数
- **比特数**
    - 8
- **具体含义**
    - 1.0 指示主机它将接收到的状态数目，之后主机将在这些状态之间循环执行
- **生成此字段正常流程**
    - 1.0 对用户实际拖动选择的模块进行识别，统计其中串行的模块的数目 
        - 1.0.1 这里的串行模块是指：例如用户想要先使小车前进3s，再左转1s，则这是串行模块；如果用户想要一边前进一边闪烁led则是并行
    - 2.0 将数目转化为对应的8位无符号二进制数
    - 3.0 允许范围0 ~ 255
- **生成此字段扩展流程**
    - 1.0 用户选择的串行的模块数目大于255
        - 1.0.1 系统提示“所用的并行模块数目已经大于255”，并要求用户修改

### 主机头位串2: 主机将循环发送给从机的控制字串的数目
- **ID**
    - h2
- **名称**
    - 主机将循环发送给从机的控制字串的数目
- **比特数**
    - 16
- **具体含义**
    - 1.0 指示主机将要向它的从机发送的状态控制字数目以及每个状态控制字的发送时间长度，之后主机将在这些控制字之间循环发送
        - 1.0.1 其中高8位指示发送的控制字数目
        - 1.0.2 其中低8位指示每个控制字的发送时长，时长用独热码表示，共分8个档位
- **生成此字段正常流程**
    - 1.0 如果用户选择让主机给从机发送控制字串，则需有第二个窗口用来设置从机的行为(配置与设置主机的窗口一致)
        - 1.0.1 用户在配置从机行为的窗口里设置从机行为
        - 1.0.2 将从机的行为编成码字，发送给主机
    - 1.1 如果用户没有选择让主机给从机发送控制字串，则不需有第二个窗口用来设置从机的行为，且这16位默认为0
    
- **生成此字段扩展流程**
    - 无


### 主机头位串3: 保留
- **ID**
    - h3
- **名称**
    - 保留
- **比特数**
    - 8
- **具体含义**
    - 1.0 不传递实际信息，用以扩展功能使用，并使主机头信息保持长度为32bits
- **生成此字段正常流程**
    - 1.0 填充8个0
- **生成此字段扩展流程**
    - 无

### 控制字1: 是否接受红外 Aa
- **ID**
    - c1
- **名称**
    - 是否接受红外
- **比特数**
    - 1
- **具体含义**
    - 1.0 确定从机是否接受红外线，注意这只对从机生效，对主机无效，主机默认不接受红外信息
- **生成此字段正常流程**
    - 1.0 如果用户选择从机屏蔽红外线，则置为0  
    - 1.1 如果用户选择接受红外线或者不进行设置，则置为1 
    - 2.0 如果用户选择主机屏蔽红外线或不进行设置，则置位0
    - 2.1 如果用户选择主机接受红外线，则进入扩展流程
- **生成此字段扩展流程**
    - 2.1 如果用户选择主机接受红外线
        - 2.1.1 系统提示用户“无法设置主机接受红外信息”，并要求用户继续更改

### 控制字2: 是否转发控制字 Bb
- **ID**
    - c2
- **名称**
    - 是否转发控制字
- **比特数**
    - 1
- **具体含义**
    - 1.0 确定主机或从机是否能转发控制字。
        - 1.0.1 主机默认为1，将从机的控制字发送给从机 '1'
        - 1.0.2 主机控制从机能否发送控制字。 '0'
            - 1.0.2.1 若从机为1，则从机把自己的状态一直向别的从机发送
            - 1.0.2.2 若从机为0，则不向外发送控制字
- **生成此字段正常流程**
    - 1.0 在用户编写主机的行为时，默认主机该位为1，即对用户隐藏 
    - 1.1 若用户编写从机的行为(见h2正常流程2.0)，用户需要选择是否从机向外转发自己的行为。
        - 1.1.1 若用户要求从机向外转发自己的行为，则置为1
        - 1.1.2 否则置为0
- **生成此字段扩展流程**
    - 无


### 控制字3: 驱动马达 Cc + 
- **ID**
    - c3
- **名称**
    - 驱动马达
- **比特数**
    - 7
- **具体含义**
    - 1.0 指示接收到码字的机器如何控制马达(前进方向、前进速度、持续时间) 
     - 1.0.1 最高1位表示是否选择主机或从机驱动马达，是则置为1，否则为0
      - 1.0.2 次高两位（56）表示前进方向(分为前进、左转、右转、随机前进四种）  0 1 2 3 
      - 1.0.3 中间（34）两位表示前进速度(分为4个档位，00最慢-静止，11最快) 0 1 2 3 
      - 1.0.4 低两位（12）表示持续时间(分为4个档位，00最短-0s，11最长) 0 1 2 3 
- **生成此字段正常流程**
    - 1.0 如果用户选择驱动马达让小车行走起来，则本模块内需要用户设置参数，并根据用户的参数来生成码字
    - 1.1 如果用户没有选择驱动马达，则默认这6位为0
- **生成此字段扩展流程**
    - 无

### 控制字4: 驱动LED 
- **ID**
    - c4
- **名称**
    - 驱动LED
- **比特数**
    - 4
- **具体含义**
    - 1.0 确定主机或从机驱动哪一个LED灯，确定亮多长时间
     - 1.0.1 高2位确定驱动哪一个LED灯(00-11四种情况)
     - 1.0.2 低2位确定驱动多长时间(分为4个档位，00最短-0s，11最长)
- **生成此字段正常流程**
    - 1.0 如果用户选择驱动LED灯，则本模块内需要用户设置参数，并根据用户的参数来生成码字
    - 1.1 如果用户没有选择驱动LED灯，则默认这6位为0
- **生成此字段扩展流程**
    - 无

### 控制字5: 超声波智能避障 Dd +
- **ID**
    - c5
- **名称**
    - 超声波智能避障
- **比特数**
    - 5
- **具体含义**
    - 1.0 确定主机或从机是否进行超声波避障，并确定避障半径
        - 1.0.1 高1位表示是否选择主机或从机超声波避障，是则置为1，否则为0  
        - 1.0.2 中间2位表示避障半径，设置为4个档位 0 1 2 3 
        - 1.0.3 低2位表示持续时间(分为4个档位，00最短-0s，11最长) 0 1 2 3 
- **生成此字段正常流程**
    - 1.0 如果用户选择主机或从机超声波避障，则置为1
    - 1.1 如果用户选择不进行设置，则置为0 
- **生成此字段扩展流程**
    - 无

### 控制字6: 语音识别模块 Ee 
- **ID**
    - c6
- **名称**
    - 语音识别模块
- **比特数**
    - 1
- **具体含义**
    - 1.0 确定主机或从机是否进行语音识别
- **生成此字段正常流程**
    - 1.0 如果用户选择主机或从机进行语音识别，则置为1
    - 1.1 如果用户选择不进行设置，则置为0
- **生成此字段扩展流程**
    - 无

### 控制字7: 红外线人体感应
- **ID**
    - c7
- **名称**
    - 红外线人体感应
- **比特数**
    - 1
- **具体含义**
    - 1.0 确定主机或从机是否进行红外线人体感应
- **生成此字段正常流程**
    - 1.0 如果用户选择主机或从机进行红外线人体感应，则置为1
    - 1.1 如果用户选择不进行设置，则置为0
- **生成此字段扩展流程**
    - 无

### 控制字8: 保留
- **ID**
    - c8
- **名称**
    - 保留
- **比特数**
    - 12
- **具体含义**
    - 1.0 不传递实际信息，用以扩展功能使用，并使控制字保持长度为32bits
- **生成此字段正常流程**
    - 1.0 填充9个0
- **生成此字段扩展流程**
    - 1.0 无

### 控制字9: 奇偶校验
- **ID**
    - c9
- **名称**
    - 奇偶校验
- **比特数**
    - 1
- **具体含义**
    - 1.0 对红外发送的控制字生成奇偶校验位
- **生成此字段正常流程**
    - 1.0 由硬件实现，软件不需要考虑
- **生成此字段扩展流程**
    - 1.0 无
